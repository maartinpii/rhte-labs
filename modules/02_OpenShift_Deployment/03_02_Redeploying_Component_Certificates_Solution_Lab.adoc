:scrollbar:
:data-uri:
:toc2:
:linkattrs:
:imagesdir: images
:opencf: link:https://labs.opentlc.com/[OPENTLC lab portal^]
:course_name: Red Hat OpenShift Operations
:account_management: link:https://www.opentlc.com/account/[OPENTLC Account Management page^]
:catalog_name: OPENTLC Cloud Infrastructure
:open_shared_ocp: link:https://master.na.openshift.opentlc.com/[OPENTLC OpenShift portal^]
:need_client: false
:show_solution: true

== Component Certificates Redeployment Lab

This lab depends up the first lab, "OpenShift Certificate Authorities Redeployment Lab." If that is not complete, this lab will fail.

Components of the OpenShift system have their own certificate authorities (CAs). In the previous lab, you updated the Platform CA with the Intermediate CA certificate. The system continued to function because deploying the new CA certificates affects only new server certificates signed by this CA, not existing ones.

In this lab, you redeploy the certificates of the rest of the OpenShift cluster. New certificates are generated--each from their own CA certificates appropriate for their component type. You see that some CA certificates change, while other do not.

Finally, you make the Intermediate CA certificate available to your client tools, i.e., your web browser and `oc` command line tools. Without the Intermediate CA certificate available to the client tools, they have no way of verifying the certificate presented by OpenShift.  The tools would then present a certificate verification error when accessing the OpenShift, and then prompt you to accept unknown certificates.  With the Intermediate CA certificate available to your client tools, the certificates presented by OpenShift can be verified successfully, and the there are no certificate verification errors.


:numbered:



==== Preliminary Important Notes

. *Performance*: The lab environment is cloudased, so you can access it over
 the WAN from anywhere. However, do not expect its performance to match a
  bare-metal environment.

. *Remote Access*: The bastion host is the only host that you can access with
 SSH outside the lab environment. External SSH for all other hosts is blocked.
  From the bastion host, you can access the other hosts internally through SSH.
   As described earlier, you must access the system (not as `root`) with your
    private SSH key and OPENTLC login.

. *GUID*: Each lab environment is assigned a global unique identifier (GUID)
 with four characters, which you receive by email when provisioning your lab
  environment. *From this point on, replace _GUID_ with your lab's four-character GUID.*

. *Bastion host* is *not* an OpenShift cluster member or part of the OpenShift
 environment. The bastion host mimics your client's infrastructure or your
  laptop or desktop that is connected to the client's local area network (LAN).
+
[TIP]
It is recommended to use a terminal multiplexing tool, such as
 *tmux* or *screen*, which keeps your place in the session if you are
  disconnected from your environment. You can install their packages after
   setting up the `rhel` repositories `yum install tmux`.
If you use tmux, type *Ctrl+B* (to enter "scroll mode") + page up or down to
 scroll, and use the *Esc* key to exit scroll mode.
You can detach from tmux : `Ctrl+B  D` or simply close you terminal. To attach
 again an existing tmux session, run the command `tmux attach` once you're
  connected to the bastion host.
+
. Provisioned Environment Hosts

These are the hosts that have been deployed in your lab environment:

* Bastion (administration) server: `bastion.GUID.example.opentlc.com`, `bastion.GUID.internal`
* NFS server: `support1.GUID.example.opentlc.com`, `support1.GUID.internal`
* Load balancer: `loadbalancer.GUID.example.opentlc.com`, `loadbalancer1.GUID.internal`
* 3 OpenShift master nodes: `master{1,2,3}.GUID.example.opentlc.com`, `master{1,2,3}.GUID.internal`
* 2 OpenShift infrastructure nodes: `infranode{1,2}.GUID.example.opentlc.com`, `infranode{1,2}.GUID.internal`
* 1 OpenShift worker node: `node1.GUID.example.opentlc.com`, `node1.GUID.internal`
* IPA Server: `ipa.shared.example.opentlc.com` (shared resource for all students)

==== Connect to Bastion Host and Explore your environment

When you connect to `bastion.GUID.example.opentlc.com` for the first time, you
will have to accept the server SSH fingerprint. Reply 'yes': it will be added
 to your `known_hosts` and not asked next time you connect.

. Connect to your administration host `bastion.GUID.example.opentlc.com`. Note that your private key location may vary.
+
[source,bash]
----
yourdesktop$ ssh -i ~/.ssh/studentkey ec2-user@bastion.GUID.example.opentlc.com
----
+
* Example of a successful connection:
+
[source,bash]
----
[gucore@work ~]$ ssh -i ~/.ssh/studentkey ec2-user@bastion.9e91.example.opentlc.com
----
+
[source,text]
----
The authenticity of host 'bastion.9e91.example.opentlc.com (31.220.66.121)' can't be established.
ECDSA key fingerprint is SHA256:fR4vFVswyvpj/Jevfin3+X0Fkehbfx4HBjw46AeIS14.
ECDSA key fingerprint is MD5:bb:25:92:ee:c9:ba:23:71:b7:c1:f7:2d:89:6d:b0:66.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'bastion.9e91.example.opentlc.com,31.220.66.121' (ECDSA) to the list of known hosts.
Creating home directory for ec2-user.
[ec2-userbastion.9e91 ~]$
----

. Run `sudo -i` to become the `root` user on the bastion host:
+
[source,bash]
----
sudo -i
----
+
. Ensure that you have a GUID environment variable set to make entering commands
easier
+
[source,bash]
----
echo ${GUID}
----
+
The output should be your GUID.
+
If the output is NOT your GUID, execute the following to set your unique identifier as the GUID environment variable:
+
[source,bash]
----
export GUID=$(hostname | cut -d. -f2)
----
+
Validate that it is set, and add it to your profile.
+
[source,bash]
----
echo ${GUID}; echo "export GUID=${GUID}" >> /root/.bashrc
----


. A sample Ansible inventory file with host in your environment has been created
 for you, have a look at `/etc/ansible/hosts`
+
[source,bash]
----
cat /etc/ansible/hosts
----
+
. Use the Ansible `--list-hosts` command line to list the masters, nodes, and
 all of the host groups:
+
.. List the "masters" host group:
+
[source,bash]
----
ansible masters --list-hosts
----
+
Expect the output to look similar to this:
+
[source,text]
----
  hosts (3):
    master1.GUID.internal
    master2.GUID.internal
    master3.GUID.internal
----
+
.. List the "nodes" host group (Remember, Masters are Nodes too):
+
[source,bash]
----
ansible nodes --list-hosts
----
+
Expect the output to look similar to this:
+
[source,bash]
----
hosts (8):
    master1.GUID.internal
    master2.GUID.internal
    master3.GUID.internal
    infranode1.GUID.internal
    infranode2.GUID.internal
    node1.GUID.internal
    node2.GUID.internal
----
+
.. List the "all" host group:
+
[source,bash]
----
ansible all --list-hosts
----
+
Expect the output to look similar to this:
+
[source,text]
----
hosts (10):
    master1.GUID.internal
    master2.GUID.internal
    master3.GUID.internal
    infranode1.GUID.internal
    infranode2.GUID.internal
    node1.GUID.internal
    node2.GUID.internal
    loadbalancer1.GUID.internal
    support1.GUID.internal
----
+
. Test the Ansible configuration by using the Ansible "ping" module to contact all
the hosts.  This also ensures that all the hosts are running.:
+
[source,bash]
----
ansible all -m ping
----
+
Expect the output to look similar to this:
+
[source,text]
----
loadbalancer1.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
infranode1.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
master2.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
master3.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
master1.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
infranode2.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
node1.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
node2.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
support1.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
node3.GUID.internal | SUCCESS => {
    "changed": false,
    "failed": false,
    "ping": "pong"
}
----



=== Prepare Environment

. Log in to your OpenShift Bastion host and switch to the `root` user.
+
[source,bash]
----
sudo -i
----

* If this was a high availability environment, the OpenShift Master API service would be accessed through the load balancer.

. Find the proper hostname and port of the Master API from the  `openshift_master_cluster_hostname` variable in the Ansible inventory file, and put it in a shell variable for ease of use:
+
[source,bash]
----
MASTER_API_HOSTPORT=`awk -F"[= ]" '/openshift_master_cluster_public_hostname/ {print $2}' /etc/ansible/hosts`:443; echo $MASTER_API_HOSTPORT
----

. Set an environment variable with your environment's GUID.
+
[source,bash]
----
export GUID=$(hostname | cut -f2 -d.); echo $GUID
----


. Do the same for the router on the infrastructure node--the port number is `443`:
+
[source,bash]
----
ROUTER=infranode1.${GUID}.internal:443; echo ${ROUTER}
----



== Examine Existing Certificates

. Examine the existing server certificates using `openssl s_client` to connect to the master:
+
[source,bash]
----
echo QUIT | openssl s_client -connect ${MASTER_API_HOSTPORT} 2>&1 | more
----
+
.Sample Output
[source,text]
----
Thu Sep  7 11:11:49 2017

depth=1 CN = openshift-signer@1504795784
verify error:num=19:self signed certificate in certificate chain
verify return:0s
CONNECTED(00000003)
---
Certificate chain
 0 s:/CN=172.30.0.1
   i:/CN=openshift-signer@1504795784
 1 s:/CN=openshift-signer@1504795784
   i:/CN=openshift-signer@1504795784
---
Server certificate
-----BEGIN CERTIFICATE-----
### -------8<-snip-8<-------
-----END CERTIFICATE-----
subject=/CN=172.30.0.1
issuer=/CN=openshift-signer@1504795784
---
Acceptable client certificate CA names
/CN=openshift-signer@1504795784
Server Temp Key: ECDH, prime256v1, 256 bits
----
* Note that the "Subject" field of the `ca.crt` certificate in the previous lab matches the certificates in the `Certificate chain` section.

. Examine the router's certificates:
+
[source,bash]
----
echo QUIT | openssl s_client -connect ${ROUTER} 2>&1 | more
----
+
.Sample Output
[source,text]
----
Certificate chain
 0 s:/CN=router.default.svc
   i:/CN=openshift-service-serving-signer@1504795784
 1 s:/CN=openshift-service-serving-signer@1504795784
   i:/CN=openshift-service-serving-signer@1504795784
---
Server certificate
-----BEGIN CERTIFICATE-----
<OMITTED>
-----END CERTIFICATE-----
subject=/CN=router.default.svc
issuer=/CN=openshift-service-serving-signer@1504795784
---
No client certificate CA names sent
Server Temp Key: ECDH, prime256v1, 256 bits
----
* Note that the router has a different CA certificate and does _not_ express any client CA names.


== Redeploy and Validate Certificates

. Run the `redeploy-certificates.yml` Ansible Playbook:
+
[source,bash]
----
time ansible-playbook -i /etc/ansible/hosts -v -f 20 /usr/share/ansible/openshift-ansible/playbooks/byo/openshift-cluster/redeploy-certificates.yml
----
* This command takes about six minutes to complete.

. Now that the certificates are redeployed, examine the certificates offered by the OpenShift Master API:
+
[source,bash]
----
echo QUIT | openssl s_client -connect ${MASTER_API_HOSTPORT} 2>&1 | less
----
+
.Sample Output
[source,text]
----
Certificate chain
 0 s:/CN=172.30.0.1
   i:/C=US/ST=North Carolina/O=Red Hat, Inc./OU=GPTE DevOps/CN=Red Hat OpenTLC Classroom Intermediate CA/emailAddress=gpte-devops-automation@redhat.com
 1 s:/C=US/ST=North Carolina/O=Red Hat, Inc./OU=GPTE DevOps/CN=Red Hat OpenTLC Classroom Intermediate CA/emailAddress=gpte-devops-automation@redhat.com
   i:/C=US/ST=North Carolina/L=Raleigh/O=Red Hat, Inc./OU=GPTE DevOps/CN=Red Hat OpenTLC Classroom Root CA/emailAddress=gpte-devops-automation@redhat.com
---
Server certificate
-----BEGIN CERTIFICATE-----
-----END CERTIFICATE-----
subject=/CN=172.30.0.1
issuer=/C=US/ST=North Carolina/O=Red Hat, Inc./OU=GPTE DevOps/CN=Red Hat OpenTLC Classroom Intermediate CA/emailAddress=gpte-devops-automation@redhat.com
---
Acceptable client certificate CA names
/C=US/ST=North Carolina/O=Red Hat, Inc./OU=GPTE DevOps/CN=Red Hat OpenTLC Classroom Intermediate CA/emailAddress=gpte-devops-automation@redhat.com
/CN=openshift-signer@1504795784
Server Temp Key: ECDH, prime256v1, 256 bits
----
* Expect the certificate chain in the output to be significantly different from the certificate chain displayed earlier.
* Expect to see that the Intermediate certificate of the Platform CA signed the server certificate.

=== Configure Bastion Host `oc` Command with new CA Certificates

By depoying new CA keys and certificates, the certificate on the Bastion host for the `system:admin` user is now incorrect.  The certificate for the `system:admin` user was regenerated on the master.  It must be copied to the Bastion host in order to continue using the `oc` occmand on the bastion host.

. Execute the following steps on the Bastion host to put the proper configuration file with the `system:admin` certificates in place.
+
[source, bash, numbered]
----
mv /root/.kube/ /root/.oldkube
ansible masters[0] -m fetch -a"src=/root/.kube/config dest=/root/.kube/config flat=yes"
----
+
[TIP]
Use `sudo` to copy the file to the home directory and change its permissions.
Then `scp` the file to the proper place on your bastion.

. Run the `oc` command once from the Bastion, while indicating the proper CA certificate.
+
[source, bash]
----
oc login -u user1 -p 'r3dh4t1!' --certificate-authority=/root/certs/ca/intermediate/certs/intermediate.cert.pem
----
+
Further `oc` commands on the bastion host root user, even logouts and logins, will not require the `--certificate-authortiy=` option.

== Configure Web Browser

=== Copy Intermediate CA Certificate

. On the bastion host, copy the Intermediate certificate to your user's home directory in order to `scp` it to your laptop.
+
[source,bash]
----
sudo -i
cp /root/certs/ca/intermediate/certs/intermediate.cert.pem /home/<OpenTLC username>/
chown <OpenTLC username> /home/<OpenTLC username>/intermediate.cert.pem
----

. On your laptop, download the following file via scp from your bastion to your laptop using `scp`:
+
[source,bash]
----
scp -i <Your OpenTLC private key> <OpenTLC username>@bastion.${GUID}.example.opentlc.com:intermediate.cert.pem .
----
*  This is the Intermediate CA certificate that signed most of OpenShift's server certificates. Note the location it was downloaded.

=== Configure Your Web Browser

Select the following directions that reflect your client platform:

. Firefox 57 on Fedora
. Chromium on Fedora
. Firefox 57 on Mac
. Chrome on Mac

====  Configure Firefox Web Browser CA on Linux Fedora 27

. In Firefox, navigate to `about:preferences#privacy`.
. Scroll down the page, and select *View Certificates -> Authorities*:
+
. Click *Import* and select the Intermediate CA certificate file from your download location.

. Check the *Trust this CA to identify websites* box and click *OK.*
+
image:firefox_linux_certs.png[]

. Click *OK* again to close the certificates box.

. The Intermediate CA Certificate is now properly imported into Firefox 57+ on Fedora.  You may now proceed to Step 3.3 which tests the Intermediate CA Certificate.

==== Configure Chromium Web Browser CA on Linux Fedora 27

In this section, you add the Intermediate CA certificate to your Linux operating system's Chromium browser's  certificate management component.

. In Chromium, navigate to `chrome://settings/?search=Manage%20certificates` and click *Manage Certificates*.

. Select *Authorities -> Import*.

. From the file selection dialog box, select the Intermediate CA certificate file and click *Open*.

. Tick the checkbox that indicates *Trust thie certificate for identifying websites*, and click *OK*.

. You should see the Red Hat OpenTLC Classroom Intermediate CA" in the list of trusted authorities as depicted here:
+
image:chromium_linux_certs.png[]

. The Intermediate CA Certificate is now properly imported into Chromium on Fedora.  You may now proceed to Step 3.3 which tests the Intermediate CA Certificate.

====  Configure Firefox Web Browser CA on Mac

. In Firefox, navigate to `about:preferences#privacy`.
. Scroll down the page, and select *View Certificates -> Authorities*:
+
. Click *Import* and select the Intermediate CA certificate file from your download location.

. Check the *Trust this CA to identify websites* box and click *OK.*
+
image:firefox_mac_certs.png[]

. Click *OK* again to close the certificates box.

. The Intermediate CA Certificate is now properly imported into Firefox 57+ on Mac.  You may now proceed to Step 3.3 which tests the Intermediate CA Certificate.

==== Configure Chrome Web Browser CA on Mac

In this section, you add the Intermediate CA certificate to your Mac operating
 system's certificate management application.

. In Chrome, navigate to `chrome://settings/?search=Manage%20certificates` and click *Manage Certificates*.
* Expect your operating system's certificate management box to appear.
+
[NOTE]
The instructions that follow are for the macOS operating system.

. Import the Intermediate CA file into the System keychain. Click the *System* keychain, and then click the padlock above *Click to unlock the System keychain*:
+

. Enter your password and click *Modify Keychain*.

. At the bottom of the box, click the section "Certificates" and then the *+* to add the certificate.

. From the file selection dialog box, select the Intermediate CA certificate file and click *Open*.

. If prompted for your macOS password, enter it to import the certificate.

. Select the name of the new Intermediate CA from the list and type `command+I` to invoke the *Get Info* dialog for this certificate.

. Click the triangle to expand the *Trust* section.

. Select the list box next to *Secure Sockets Layer (SSL)* and set it to `Always Trust`, and close the window.

. Enter your password again if prompted.

. Your Keychain Access application should include the following highlighted line:
+
image:chrome_mac_certs.png[]

. Click the *lock* icon to lock the keychain.  Enter your password if required.

. Close the *Keychain Access* window.

. The Intermediate CA Certificate is now properly imported into Chrome on Mac.  You may now proceed to Step 3.3 which tests the Intermediate CA Certificate.


=== Test Intermediate CA Certificate

. Browse to your master's public hostname at `https://loadbalancer.$GUID.example.opentlc.com/`, making sure to substitute your GUID for the `$GUID` in the URL.
* Note that you do not get a certificate error. You are able to log in and browse without warnings or errors.

== Summary

In this lab we ran through the very typical activities of an OpenShift consultant at a security-aware customer:

* Redployed Component Certificates using the ansible playbook
* Validated the redeployed certificates were indeed the certificate we intended
* Configured our web browsers to work with the new Intermediate CA Certificate
